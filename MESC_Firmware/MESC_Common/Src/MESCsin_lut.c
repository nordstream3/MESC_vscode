/*
 **
 ******************************************************************************
 * @file           : MESCsin_lut.c
 * @brief          : Sine LUT
 ******************************************************************************
 * @attention
 *
 * <h2><center>&copy; Copyright (c) 2020 David Molony.
 * All rights reserved.</center></h2>
 *
 * This software component is licensed under BSD 3-Clause license,
 * the "License"; You may not use this file except in compliance with the
 * License. You may obtain a copy of the License at:
 *                        opensource.org/licenses/BSD-3-Clause
 *
 ******************************************************************************

 * MESCsin_lut.c
 *
 *  Created on: 11 Apr 2022
 *      Author: David Molony
 *      		Jens Kerrinnes - Added higher res sin_lut
 *
 */

/* Includes ------------------------------------------------------------------*/

#include "MESCsin_lut.h"
#include <stdint.h>
#include "MESChw_setup.h"

#if !USE_HIGH_RES
// Vector 256 long of sin wave, stretched by 65 to allow computation of cosine as sin(angle+64) without needing wrapping
const float sinwave[321] = { 0.0000000000,  0.0245412285,  0.0490676743,  0.0735645636,  0.0980171403,  0.1224106752,  0.1467304745,  0.1709618888,
							 0.1950903220,  0.2191012402,  0.2429801799,  0.2667127575,  0.2902846773,  0.3136817404,  0.3368898534,  0.3598950365,
							 0.3826834324,  0.4052413140,  0.4275550934,  0.4496113297,  0.4713967368,  0.4928981922,  0.5141027442,  0.5349976199,
							 0.5555702330,  0.5758081914,  0.5956993045,  0.6152315906,  0.6343932842,  0.6531728430,  0.6715589548,  0.6895405447,
							 0.7071067812,  0.7242470830,  0.7409511254,  0.7572088465,  0.7730104534,  0.7883464276,  0.8032075315,  0.8175848132,
							 0.8314696123,  0.8448535652,  0.8577286100,  0.8700869911,  0.8819212643,  0.8932243012,  0.9039892931,  0.9142097557,
							 0.9238795325,  0.9329927988,  0.9415440652,  0.9495281806,  0.9569403357,  0.9637760658,  0.9700312532,  0.9757021300,
							 0.9807852804,  0.9852776424,  0.9891765100,  0.9924795346,  0.9951847267,  0.9972904567,  0.9987954562,  0.9996988187,
							 1.0000000000,  0.9996988187,  0.9987954562,  0.9972904567,  0.9951847267,  0.9924795346,  0.9891765100,  0.9852776424,
							 0.9807852804,  0.9757021300,  0.9700312532,  0.9637760658,  0.9569403357,  0.9495281806,  0.9415440652,  0.9329927988,
							 0.9238795325,  0.9142097557,  0.9039892931,  0.8932243012,  0.8819212643,  0.8700869911,  0.8577286100,  0.8448535652,
							 0.8314696123,  0.8175848132,  0.8032075315,  0.7883464276,  0.7730104534,  0.7572088465,  0.7409511254,  0.7242470830,
							 0.7071067812,  0.6895405447,  0.6715589548,  0.6531728430,  0.6343932842,  0.6152315906,  0.5956993045,  0.5758081914,
							 0.5555702330,  0.5349976199,  0.5141027442,  0.4928981922,  0.4713967368,  0.4496113297,  0.4275550934,  0.4052413140,
							 0.3826834324,  0.3598950365,  0.3368898534,  0.3136817404,  0.2902846773,  0.2667127575,  0.2429801799,  0.2191012402,
							 0.1950903220,  0.1709618888,  0.1467304745,  0.1224106752,  0.0980171403,  0.0735645636,  0.0490676743,  0.0245412285,
							 0.0000000000, -0.0245412285, -0.0490676743, -0.0735645636, -0.0980171403, -0.1224106752, -0.1467304745, -0.1709618888,
							-0.1950903220, -0.2191012402, -0.2429801799, -0.2667127575, -0.2902846773, -0.3136817404, -0.3368898534, -0.3598950365,
							-0.3826834324, -0.4052413140, -0.4275550934, -0.4496113297, -0.4713967368, -0.4928981922, -0.5141027442, -0.5349976199,
							-0.5555702330, -0.5758081914, -0.5956993045, -0.6152315906, -0.6343932842, -0.6531728430, -0.6715589548, -0.6895405447,
							-0.7071067812, -0.7242470830, -0.7409511254, -0.7572088465, -0.7730104534, -0.7883464276, -0.8032075315, -0.8175848132,
							-0.8314696123, -0.8448535652, -0.8577286100, -0.8700869911, -0.8819212643, -0.8932243012, -0.9039892931, -0.9142097557,
							-0.9238795325, -0.9329927988, -0.9415440652, -0.9495281806, -0.9569403357, -0.9637760658, -0.9700312532, -0.9757021300,
							-0.9807852804, -0.9852776424, -0.9891765100, -0.9924795346, -0.9951847267, -0.9972904567, -0.9987954562, -0.9996988187,
							-1.0000000000, -0.9996988187, -0.9987954562, -0.9972904567, -0.9951847267, -0.9924795346, -0.9891765100, -0.9852776424,
							-0.9807852804, -0.9757021300, -0.9700312532, -0.9637760658, -0.9569403357, -0.9495281806, -0.9415440652, -0.9329927988,
							-0.9238795325, -0.9142097557, -0.9039892931, -0.8932243012, -0.8819212643, -0.8700869911, -0.8577286100, -0.8448535652,
							-0.8314696123, -0.8175848132, -0.8032075315, -0.7883464276, -0.7730104534, -0.7572088465, -0.7409511254, -0.7242470830,
							-0.7071067812, -0.6895405447, -0.6715589548, -0.6531728430, -0.6343932842, -0.6152315906, -0.5956993045, -0.5758081914,
							-0.5555702330, -0.5349976199, -0.5141027442, -0.4928981922, -0.4713967368, -0.4496113297, -0.4275550934, -0.4052413140,
							-0.3826834324, -0.3598950365, -0.3368898534, -0.3136817404, -0.2902846773, -0.2667127575, -0.2429801799, -0.2191012402,
							-0.1950903220, -0.1709618888, -0.1467304745, -0.1224106752, -0.0980171403, -0.0735645636, -0.0490676743, -0.0245412285,
							 0.0000000000,  0.0245412285,  0.0490676743,  0.0735645636,  0.0980171403,  0.1224106752,  0.1467304745,  0.1709618888,
							 0.1950903220,  0.2191012402,  0.2429801799,  0.2667127575,  0.2902846773,  0.3136817404,  0.3368898534,  0.3598950365,
							 0.3826834324,  0.4052413140,  0.4275550934,  0.4496113297,  0.4713967368,  0.4928981922,  0.5141027442,  0.5349976199,
							 0.5555702330,  0.5758081914,  0.5956993045,  0.6152315906,  0.6343932842,  0.6531728430,  0.6715589548,  0.6895405447,
							 0.7071067812,  0.7242470830,  0.7409511254,  0.7572088465,  0.7730104534,  0.7883464276,  0.8032075315,  0.8175848132,
							 0.8314696123,  0.8448535652,  0.8577286100,  0.8700869911,  0.8819212643,  0.8932243012,  0.9039892931,  0.9142097557,
							 0.9238795325,  0.9329927988,  0.9415440652,  0.9495281806,  0.9569403357,  0.9637760658,  0.9700312532,  0.9757021300,
							 0.9807852804,  0.9852776424,  0.9891765100,  0.9924795346,  0.9951847267,  0.9972904567,  0.9987954562,  0.9996988187,
							 1.0000000000};

void sin_cos_fast( uint16_t angle , float * sin, float * cos)
{
	*sin = sinwave[angle >> 8];
	*cos = sinwave[(angle >> 8) + 64];
}
#endif


#if USE_HIGH_RES
#define SIN_COS_TABLE {\
0,			 0.006135885, 0.012271538, 0.018406730, 0.024541229, 0.030674803, 0.036807223, 0.042938257,\
0.049067674, 0.055195244, 0.061320736, 0.067443920, 0.073564564, 0.079682438, 0.085797312, 0.091908956,\
0.098017140, 0.104121634, 0.110222207, 0.116318631, 0.122410675, 0.128498111, 0.134580709, 0.140658239,\
0.146730474, 0.152797185, 0.158858143, 0.164913120, 0.170961889, 0.177004220, 0.183039888, 0.189068664,\
0.195090322, 0.201104635, 0.207111376, 0.213110320, 0.219101240, 0.225083911, 0.231058108, 0.237023606,\
0.242980180, 0.248927606, 0.254865660, 0.260794118, 0.266712757, 0.272621355, 0.278519689, 0.284407537,\
0.290284677, 0.296150888, 0.302005949, 0.307849640, 0.313681740, 0.319502031, 0.325310292, 0.331106306,\
0.336889853, 0.342660717, 0.348418680, 0.354163525, 0.359895037, 0.365612998, 0.371317194, 0.377007410,\
0.382683432, 0.388345047, 0.393992040, 0.399624200, 0.405241314, 0.410843171, 0.416429560, 0.422000271,\
0.427555093, 0.433093819, 0.438616239, 0.444122145, 0.449611330, 0.455083587, 0.460538711, 0.465976496,\
0.471396737, 0.476799230, 0.482183772, 0.487550160, 0.492898192, 0.498227667, 0.503538384, 0.508830143,\
0.514102744, 0.519355990, 0.524589683, 0.529803625, 0.534997620, 0.540171473, 0.545324988, 0.550457973,\
0.555570233, 0.560661576, 0.565731811, 0.570780746, 0.575808191, 0.580813958, 0.585797857, 0.590759702,\
0.595699304, 0.600616479, 0.605511041, 0.610382806, 0.615231591, 0.620057212, 0.624859488, 0.629638239,\
0.634393284, 0.639124445, 0.643831543, 0.648514401, 0.653172843, 0.657806693, 0.662415778, 0.666999922,\
0.671558955, 0.676092704, 0.680600998, 0.685083668, 0.689540545, 0.693971461, 0.698376249, 0.702754744,\
0.707106781, 0.711432196, 0.715730825, 0.720002508, 0.724247083, 0.728464390, 0.732654272, 0.736816569,\
0.740951125, 0.745057785, 0.749136395, 0.753186799, 0.757208847, 0.761202385, 0.765167266, 0.769103338,\
0.773010453, 0.776888466, 0.780737229, 0.784556597, 0.788346428, 0.792106577, 0.795836905, 0.799537269,\
0.803207531, 0.806847554, 0.810457198, 0.814036330, 0.817584813, 0.821102515, 0.824589303, 0.828045045,\
0.831469612, 0.834862875, 0.838224706, 0.841554977, 0.844853565, 0.848120345, 0.851355193, 0.854557988,\
0.857728610, 0.860866939, 0.863972856, 0.867046246, 0.870086991, 0.873094978, 0.876070094, 0.879012226,\
0.881921264, 0.884797098, 0.887639620, 0.890448723, 0.893224301, 0.895966250, 0.898674466, 0.901348847,\
0.903989293, 0.906595705, 0.909167983, 0.911706032, 0.914209756, 0.916679060, 0.919113852, 0.921514039,\
0.923879533, 0.926210242, 0.928506080, 0.930766961, 0.932992799, 0.935183510, 0.937339012, 0.939459224,\
0.941544065, 0.943593458, 0.945607325, 0.947585591, 0.949528181, 0.951435021, 0.953306040, 0.955141168,\
0.956940336, 0.958703475, 0.960430519, 0.962121404, 0.963776066, 0.965394442, 0.966976471, 0.968522094,\
0.970031253, 0.971503891, 0.972939952, 0.974339383, 0.975702130, 0.977028143, 0.978317371, 0.979569766,\
0.980785280, 0.981963869, 0.983105487, 0.984210092, 0.985277642, 0.986308097, 0.987301418, 0.988257568,\
0.989176510, 0.990058210, 0.990902635, 0.991709754, 0.992479535, 0.993211949, 0.993906970, 0.994564571,\
0.995184727, 0.995767414, 0.996312612, 0.996820299, 0.997290457, 0.997723067, 0.998118113, 0.998475581,\
0.998795456, 0.999077728, 0.999322385, 0.999529418, 0.999698819, 0.999830582, 0.999924702, 0.999981175}

const float hSin_Cos_Table[256] = SIN_COS_TABLE;

#define SIN_MASK        0x0300u
#define U0_90           0x0200u
#define U90_180         0x0300u
#define U180_270        0x0000u
#define U270_360        0x0100u


void sin_cos_fast( uint16_t angle , float * sin, float * cos)
{

  uint32_t shindex;
  uint16_t uhindex;

  /* 10 bit index computation  */
  shindex = ( ( uint32_t )32768 + ( uint32_t )angle );
  uhindex = ( uint16_t )shindex;
  uhindex /= ( uint16_t )64;

  switch ( ( uint16_t )( uhindex ) & SIN_MASK )
  {
    case U0_90:
      *sin = hSin_Cos_Table[( uint8_t )( uhindex )];
      *cos = hSin_Cos_Table[( uint8_t )( 0xFFu - ( uint8_t )( uhindex ) )];
      break;

    case U90_180:
      *sin = hSin_Cos_Table[( uint8_t )( 0xFFu - ( uint8_t )( uhindex ) )];
      *cos = -hSin_Cos_Table[( uint8_t )( uhindex )];
      break;

    case U180_270:
      *sin = -hSin_Cos_Table[( uint8_t )( uhindex )];
      *cos = -hSin_Cos_Table[( uint8_t )( 0xFFu - ( uint8_t )( uhindex ) )];
      break;

    case U270_360:
      *sin =  -hSin_Cos_Table[( uint8_t )( 0xFFu - ( uint8_t )( uhindex ) )];
      *cos =  hSin_Cos_Table[( uint8_t )( uhindex )];
      break;
    default:
      break;
  }
}
#endif


const float inductance_map[321] = {
		0.0006,0.0024,0.0054,0.0096,0.0150,0.0215,0.0292,0.0381,0.0480,0.0590,0.0711,0.0843,0.0984,0.1135,0.1295,0.1464,
		0.1642,0.1828,0.2022,0.2222,0.2429,0.2643,0.2862,0.3087,0.3316,0.3549,0.3785,0.4025,0.4266,0.4510,0.4755,0.5000,
		0.5245,0.5490,0.5734,0.5975,0.6215,0.6451,0.6684,0.6913,0.7138,0.7357,0.7571,0.7778,0.7978,0.8172,0.8358,0.8536,
		0.8705,0.8865,0.9016,0.9157,0.9289,0.9410,0.9520,0.9619,0.9708,0.9785,0.9850,0.9904,0.9946,0.9976,0.9994,1.0000,
		0.9994,0.9976,0.9946,0.9904,0.9850,0.9785,0.9708,0.9619,0.9520,0.9410,0.9289,0.9157,0.9016,0.8865,0.8705,0.8536,
		0.8358,0.8172,0.7978,0.7778,0.7571,0.7357,0.7138,0.6913,0.6684,0.6451,0.6215,0.5975,0.5734,0.5490,0.5245,0.5000,
		0.4755,0.4510,0.4266,0.4025,0.3785,0.3549,0.3316,0.3087,0.2862,0.2643,0.2429,0.2222,0.2022,0.1828,0.1642,0.1464,
		0.1295,0.1135,0.0984,0.0843,0.0711,0.0590,0.0480,0.0381,0.0292,0.0215,0.0150,0.0096,0.0054,0.0024,0.0006,0.0000,
		0.0006,0.0024,0.0054,0.0096,0.0150,0.0215,0.0292,0.0381,0.0480,0.0590,0.0711,0.0843,0.0984,0.1135,0.1295,0.1464,
		0.1642,0.1828,0.2022,0.2222,0.2429,0.2643,0.2862,0.3087,0.3316,0.3549,0.3785,0.4025,0.4266,0.4510,0.4755,0.5000,
		0.5245,0.5490,0.5734,0.5975,0.6215,0.6451,0.6684,0.6913,0.7138,0.7357,0.7571,0.7778,0.7978,0.8172,0.8358,0.8536,
		0.8705,0.8865,0.9016,0.9157,0.9289,0.9410,0.9520,0.9619,0.9708,0.9785,0.9850,0.9904,0.9946,0.9976,0.9994,1.0000,
		0.9994,0.9976,0.9946,0.9904,0.9850,0.9785,0.9708,0.9619,0.9520,0.9410,0.9289,0.9157,0.9016,0.8865,0.8705,0.8536,
		0.8358,0.8172,0.7978,0.7778,0.7571,0.7357,0.7138,0.6913,0.6684,0.6451,0.6215,0.5975,0.5734,0.5490,0.5245,0.5000,
		0.4755,0.4510,0.4266,0.4025,0.3785,0.3549,0.3316,0.3087,0.2862,0.2643,0.2429,0.2222,0.2022,0.1828,0.1642,0.1464,
		0.1295,0.1135,0.0984,0.0843,0.0711,0.0590,0.0480,0.0381,0.0292,0.0215,0.0150,0.0096,0.0054,0.0024,0.0006,0.0000,
		0.0006,0.0024,0.0054,0.0096,0.0150,0.0215,0.0292,0.0381,0.0480,0.0590,0.0711,0.0843,0.0984,0.1135,0.1295,0.1464,
		0.1642,0.1828,0.2022,0.2222,0.2429,0.2643,0.2862,0.3087,0.3316,0.3549,0.3785,0.4025,0.4266,0.4510,0.4755,0.5000,
		0.5245,0.5490,0.5734,0.5975,0.6215,0.6451,0.6684,0.6913,0.7138,0.7357,0.7571,0.7778,0.7978,0.8172,0.8358,0.8536,
		0.8705,0.8865,0.9016,0.9157,0.9289,0.9410,0.9520,0.9619,0.9708,0.9785,0.9850,0.9904,0.9946,0.9976,0.9994,1.0000
};
//Populate this with the shape of the motor inductance as a proportion 0.0f-1.0f based on normal inductance shape
//Lq-Ld is multiplied by this and added to the Ld, which is assumed to be the minimum
//Currently, this is just a sinewave offset to all values positive; range 0-2.

void getLabFast( uint16_t angle, float Ld, float Lq_Ld , float * La, float * Lb)
{
	*La = Ld + Lq_Ld * inductance_map[angle >> 8];
	*Lb = Ld + Lq_Ld * inductance_map[(angle >> 8) + 64];
}
